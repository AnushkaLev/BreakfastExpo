<!doctype html>

<html lang="en">

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />

  <title>Breakfast Rating App - Preview</title>

  <style>

    :root{
      --bg: #fbf6ef;
      --wallTop: #fffaf4;
      --wallBot: #fff3e8;

      --ink: rgba(120,110,100,.45);
      --inkSoft: rgba(120,110,100,.28);

      --woodTop:#f3caa6;
      --woodBot:#efbe95;

      --counter:#f6eadf;
      --counterEdge:#e2d3c6;

      --stove:#5b5b60;

      --potBody:#f5f1ea;
      --potLid:#f0c16a;

      --sinkFill:#bfc3c7;
      --sinkInner:#aeb3b8;

      --green1:#bfe3b9;
      --green2:#9fd39f;
      --green3:#7fc58d;

      --cream:#f3f1ea;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      margin:0;
      background: var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow-x: hidden;
    }

    .container {
      width: 100vw;
      min-height: 100vh;
      position: relative;
      padding: 18px 0;
    }

    .frame{
      width:min(900px, 96vw);
      aspect-ratio: 1.18 / 1;
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 16px 40px rgba(0,0,0,.10);
      background: var(--bg);
      margin: 0 auto;
      position: relative;
    }

    svg{ width:100%; height:100%; display:block; position: relative; z-index: 1; }

    /* Top nav (Home + Weekly Summary centered) */
    .screen-toggle {
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 10px;
    }

    .toggle-btn {
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.92);
      border: 2px solid #FFB800;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      color: #333;
      font-size: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.10);
    }

    .toggle-btn.active {
      background: #FFB800;
      color: #333;
    }

    /* Screen Containers */
    .screen {
      display: none;
      position: absolute;
      inset: 0;
      z-index: 10;
    }

    .screen.active { display: block; }

    /* HOME: kitchen background + circular live camera + 3 buttons */
    .home-screen {
      height: 100%;
      display: grid;
      place-items: center;
      padding: 24px;
    }

    .camera-ui {
      width: min(520px, 88%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
    }

    .camera-title {
      text-align: center;
      margin-bottom: 6px;
    }

    .camera-title h1{
      font-size: 34px;
      font-weight: 800;
      color: #333;
      text-shadow: 0 2px 4px rgba(255, 255, 255, 0.85);
      letter-spacing: -0.5px;
    }

    .camera-title p{
      margin-top: 6px;
      font-size: 15px;
      color: #666;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.85);
    }

    .camera-circle {
      width: min(360px, 72vw);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      border: 10px solid rgba(255,255,255,.85);
      box-shadow: 0 14px 36px rgba(0,0,0,.14);
      position: relative;
      overflow: hidden;
    }

    .camera-circle video,
    .camera-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* selfie-like */
    }

    .camera-circle .hint {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: linear-gradient(to bottom, rgba(255,255,255,.45), rgba(255,255,255,.15));
      color: rgba(70,60,55,.78);
      font-weight: 700;
      text-align: center;
      padding: 18px;
      pointer-events: none;
    }

    .camera-controls {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: center;
    }

    .circle-btn {
      width: 62px;
      height: 62px;
      border-radius: 999px;
      border: 3px solid rgba(255,255,255,.85);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      cursor: pointer;
      font-size: 22px;
      display: grid;
      place-items: center;
      transition: transform .15s ease, box-shadow .15s ease;
      user-select: none;
    }

    .circle-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 26px rgba(0,0,0,.18); }
    .circle-btn:active { transform: translateY(0px) scale(.98); }

    .circle-btn.check { color: #1B7A2A; border-color: rgba(27,122,42,.25); }
    .circle-btn.camera { color: #333; border-color: rgba(255,184,0,.30); }
    .circle-btn.library { color: #333; border-color: rgba(33,150,243,.30); }
    .circle-btn.redo { color: #333; border-color: rgba(120,110,100,.25); }

    .status-line {
      font-size: 13px;
      font-weight: 700;
      color: rgba(70,60,55,.70);
      text-shadow: 0 1px 2px rgba(255,255,255,.85);
      text-align: center;
      min-height: 18px;
    }

    /* Rating + notes section under the camera */
    .rating-notes {
      margin-top: 28px; /* Increased from 8px to move down 20px */
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px; /* Reduced from 10px to move notes closer to stars */
    }

    .rating-label {
      font-size: 13px;
      font-weight: 600;
      color: rgba(70,60,55,.80);
      text-shadow: 0 1px 2px rgba(255,255,255,.85);
    }

    .rating-stars {
      display: flex;
      gap: 6px;
    }

    .rating-star {
      font-size: 26px;
      cursor: pointer;
      color: #D8D5CF;
      transition: transform .12s ease, color .12s ease;
      text-shadow: 0 1px 2px rgba(0,0,0,.08);
      user-select: none;
    }

    .rating-star.selected {
      color: #FFB800;
      transform: translateY(-1px);
    }

    .notes-input {
      width: 100%;
      max-width: 420px;
      min-height: 70px;
      border-radius: 12px;
      border: 1px solid rgba(140,125,110,.25);
      padding: 10px 12px;
      font-size: 13px;
      resize: vertical;
      background: rgba(255,255,255,.85);
      box-shadow: 0 4px 10px rgba(0,0,0,.04);
      outline: none;
    }

    .notes-input:focus {
      border-color: #FFB800;
      box-shadow: 0 0 0 1px rgba(255,184,0,.55), 0 6px 14px rgba(0,0,0,.10);
    }

    /* Weekly Summary Screen */

    .weekly-screen {

      padding-top: 20px;

      padding-bottom: 20px;

      height: 100%;

      overflow-y: auto;

    }

    .header {

      text-align: center;

      margin-bottom: 16px;

    }

    .header-title {

      font-size: 28px;

      font-weight: 700;

      color: #333;

      margin-bottom: 4px;

      text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8);

    }

    .week-range {
      font-size: 14px;
      color: #666;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .week-nav {
      cursor: pointer;
      font-size: 18px;
      font-weight: 700;
      color: #FFB800;
      user-select: none;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background-color 0.2s;
    }

    .week-nav:hover {
      background-color: rgba(255, 184, 0, 0.1);
    }

    .week-nav:active {
      transform: scale(0.95);
    }

    .stats-card {

      background: rgba(255, 255, 255, 0.95);

      border-radius: 12px;

      padding: 16px;

      margin: 0 auto 20px;

      max-width: 400px;

      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);

    }

    .stats-row {

      display: flex;

      justify-content: space-around;

      margin-bottom: 12px;

    }

    .stat-item {

      text-align: center;

    }

    .stat-value {

      font-size: 24px;

      font-weight: 700;

      color: #333;

      margin-bottom: 4px;

    }

    .stat-label {

      font-size: 12px;

      color: #666;

      font-weight: 500;

    }

    .bottles-container {
      position: absolute;
      bottom: 92px; /* sits on the counter area visually */
      left: 0;
      width: 100%;
      padding: 0 20px;
    }

    .bottles-title {

      font-size: 18px;

      font-weight: 700;

      color: #333;

      text-align: center;

      margin-bottom: 16px;

      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);

    }

    .bottles-row {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Spice Bottle */

    .spice-bottle {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: transform 0.2s;
      width: 70px;
    }

    .spice-bottle:hover {

      transform: translateY(-5px) scale(1.05);

    }

    .bottle-cap {

      width: 52px;

      height: 10px;

      background: linear-gradient(to bottom, #B0B0B0 0%, #D0D0D0 100%);

      border-radius: 4px 4px 0 0;

      margin-bottom: 2px;

    }

    .bottle-body {

      width: 60px;

      height: 120px;

      background: rgba(255, 255, 255, 0.25);

      border: 1px solid rgba(200, 200, 200, 0.6);

      border-radius: 8px;

      position: relative;

      overflow: hidden;

      box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1);

    }

    .bottle-fill {

      position: absolute;

      bottom: 0;

      left: 2px;

      right: 2px;

      border-radius: 0 0 6px 6px;

      transition: height 0.3s ease;

    }

    .bottle-label {

      position: absolute;

      top: 6px;

      left: 7.5%;

      width: 85%;

      background: rgba(255, 255, 255, 0.98);

      border-radius: 6px;

      padding: 5px 3px;

      border: 1px solid rgba(0, 0, 0, 0.12);

      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);

      display: flex;

      flex-direction: column;

      align-items: center;

      justify-content: space-between;

      min-height: 85px;

    }

    .weekday-label {

      font-size: 8px;

      font-weight: 700;

      color: #666;

      margin-bottom: 3px;

      letter-spacing: 0.5px;

    }

    .thumbnail {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      margin: 3px 0;
      border: 1px solid rgba(0, 0, 0, 0.1);
      background: rgba(0, 0, 0, 0.03);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      overflow: hidden;
    }

    .thumbnail img {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      object-fit: cover;
      display: block;
    }

    .stars {

      display: flex;

      gap: 1px;

      margin: 2px 0;

    }

    .star {

      font-size: 8px;

      color: #DDD;

    }

    .star.filled {

      color: #FFB800;

    }

    .food-label {
      font-size: 7px;
      color: #333;
      font-weight: 600;
      text-align: center;
      margin-top: 2px;
      letter-spacing: 0.3px;
    }

    .note-text {
      font-size: 6px;
      color: #666;
      font-weight: 400;
      text-align: center;
      margin-top: 1px;
      padding: 0 2px;
      line-height: 1.2;
      max-height: 20px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .empty-label {

      font-size: 10px;

      color: #999;

      font-style: italic;

      margin-top: 8px;

    }

    /* Fill Colors */

    .fill-eggs { background-color: #FFE5B4; }

    .fill-oatmeal { background-color: #F5E6D3; }

    .fill-chia { background-color: #D4C4E8; }

    .fill-fruit { background-color: #E8F5E8; }

    .fill-yogurt { background-color: #E8F0FF; }

    .fill-default { background-color: #E8D5C4; }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #333;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      line-height: 30px;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-stars {
      display: flex;
      gap: 8px;
      margin: 10px 0;
    }

    .modal-star {
      font-size: 28px;
      color: #ddd;
      cursor: pointer;
      user-select: none;
      transition: color 0.2s;
    }

    .modal-star:hover {
      color: #FFB800;
    }

    .modal-star.selected {
      color: #FFB800;
    }

    .modal-btn {
      transition: opacity 0.2s;
    }

    .modal-btn:active {
      opacity: 0.8;
    }

    @media screen and (max-width: 500px) {
      .modal-content {
        margin: 5% auto;
        width: 95%;
      }
    }

    /* iOS WebView fixes to match desktop */
    @media screen and (max-width: 500px) {
      /* Fix 1: Make preview scene cover ~70% of viewport height */
      .container {
        padding: 0;
        min-height: 100svh;
        height: 100svh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Fix 1: Frame takes full remaining viewport height after 10svh offset */
      /* Fix 2a: Move main content down by ~10svh */
      .frame {
        width: 100vw;
        max-width: 100vw;
        margin: 0;
        margin-top: 10svh; /* Move down by 10% of viewport */
        border-radius: 0;
        height: 90svh; /* Fill remaining 90% of viewport */
        min-height: 90svh;
        max-height: 90svh;
        aspect-ratio: unset;
        flex-shrink: 0;
        overflow: hidden;
        box-sizing: border-box;
      }

      /* Fix 1: Remove white space - container fills viewport */
      body {
        overflow: hidden;
        height: 100svh;
        margin: 0;
        padding: 0;
      }

      /* Fix 2: Ensure top buttons are visible and centered - higher z-index */
      .screen-toggle {
        top: 12px;
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
        gap: 8px;
        z-index: 1001;
        position: fixed !important;
        display: flex !important;
      }

      .toggle-btn {
        padding: 8px 12px;
        font-size: 13px;
        white-space: nowrap;
        z-index: 1002;
        position: relative;
      }

      /* Fix 3: Fix z-index layering - screen content above SVG background */
      .screen {
        z-index: 20;
        position: absolute;
      }

      /* Fix 3: Camera UI and controls above circle overlay */
      .camera-ui {
        width: min(520px, 88%) !important;
        gap: 18px;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 30;
      }

      /* Fix 3: Camera circle should not cover buttons - proper z-index */
      .camera-circle {
        width: min(360px, 72vw) !important;
        aspect-ratio: 1 / 1 !important;
        max-width: 360px;
        position: relative;
        z-index: 25;
      }

      /* Fix 3: Camera controls above circle */
      .camera-controls {
        position: relative;
        z-index: 35;
        pointer-events: auto;
      }

      /* Fix 3: Circle buttons clickable */
      .circle-btn {
        position: relative;
        z-index: 36;
        pointer-events: auto;
      }

      /* Fix 4: Rating and notes visible and clickable */
      .rating-notes {
        position: relative;
        z-index: 30;
        pointer-events: auto;
        margin-top: 8px;
      }

      .rating-stars {
        position: relative;
        z-index: 31;
        pointer-events: auto;
      }

      .rating-star {
        position: relative;
        z-index: 32;
        pointer-events: auto;
        cursor: pointer;
      }

      .notes-input {
        position: relative;
        z-index: 30;
        pointer-events: auto;
      }

      /* Fix 4: Status line visible */
      .status-line {
        position: relative;
        z-index: 30;
      }

      /* Fix 2b: Ensure proper vertical centering - no scrolling */
      .home-screen {
        padding: 16px 16px 20px 16px; /* Reduced top padding, added bottom */
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important;
        align-items: center !important;
        height: 100%;
        overflow: hidden; /* No scrolling */
        box-sizing: border-box;
      }

      /* Fix 2c: Make camera-ui fit within viewport without scrolling */
      .camera-ui {
        width: min(520px, 88%) !important;
        gap: 14px !important; /* Slightly reduce gap to fit more */
        align-items: center;
        justify-content: flex-start;
        position: relative;
        z-index: 30;
        flex-shrink: 0;
      }

      /* Fix 2c: Reduce spacing to fit stars + notes, but add 20px offset */
      .rating-notes {
        position: relative;
        z-index: 30;
        pointer-events: auto;
        margin-top: 26px !important; /* 6px base + 20px offset = 26px */
        gap: 8px !important; /* Reduced from 10px */
      }

      /* Fix 2c: Make notes input smaller to fit */
      .notes-input {
        position: relative;
        z-index: 30;
        pointer-events: auto;
        min-height: 60px !important; /* Reduced from 70px */
        max-height: 80px;
      }

      /* Fix text scaling - maintain desktop proportions */
      .camera-title h1 {
        font-size: 34px;
        letter-spacing: -0.5px;
      }

      .camera-title p {
        font-size: 15px;
      }
    }

    /* iPhone 16 Pro specific (393px width) */
    @media screen and (max-width: 393px) and (max-height: 852px) {
      /* Maintain extended height on smaller devices */
      .frame {
        margin-top: 10svh;
        min-height: 90svh;
        max-height: 90svh;
      }

      .camera-circle {
        width: min(340px, 72vw) !important;
      }

      .camera-ui {
        width: min(500px, 88%) !important;
      }

      .screen-toggle {
        top: 10px;
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
        z-index: 1001;
      }

      .camera-title h1 {
        font-size: 32px;
      }
    }

  </style>

</head>

<body>

  <div class="container">

    <!-- Screen Toggle -->

    <div class="screen-toggle">

      <button class="toggle-btn active" onclick="showScreen('home')">Home</button>

      <button class="toggle-btn" onclick="showScreen('weekly')">Weekly Summary</button>

    </div>

    <div class="frame">

      <!-- Kitchen Background SVG -->

      <svg viewBox="0 0 1000 850" xmlns="http://www.w3.org/2000/svg">

        <defs>

          <filter id="grain">

            <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch" />

            <feColorMatrix type="matrix"

              values="0 0 0 0 0

                      0 0 0 0 0

                      0 0 0 0 0

                      0 0 0 .055 0"/>

          </filter>

          <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">

            <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0,0,0,.12)"/>

          </filter>

          <linearGradient id="wallGrad" x1="0" x2="0" y1="0" y2="1">

            <stop offset="0" stop-color="var(--wallTop)"/>

            <stop offset="1" stop-color="var(--wallBot)"/>

          </linearGradient>

          <linearGradient id="woodGrad" x1="0" x2="0" y1="0" y2="1">

            <stop offset="0" stop-color="var(--woodTop)"/>

            <stop offset="1" stop-color="var(--woodBot)"/>

          </linearGradient>

          <linearGradient id="outside" x1="0" x2="0" y1="0" y2="1">

            <stop offset="0" stop-color="#cfead0"/>

            <stop offset="1" stop-color="#a8d8ac"/>

          </linearGradient>

        </defs>

        <!-- WALL -->

        <rect x="0" y="0" width="1000" height="850" fill="url(#wallGrad)"/>

        <rect x="0" y="0" width="1000" height="850" filter="url(#grain)" opacity=".9"/>

        <!-- WINDOW -->

        <g filter="url(#softShadow)">

          <rect x="70" y="70" rx="22" ry="22" width="520" height="260"

                fill="#fff" stroke="var(--inkSoft)" stroke-width="5"/>

          <rect x="92" y="92" rx="18" ry="18" width="476" height="216"

                fill="url(#outside)" stroke="rgba(120,110,100,.16)" stroke-width="2"/>

          <path d="M92 250 C180 205, 265 225, 340 245 C420 210, 500 220, 568 245

                   L568 308 L92 308 Z"

                fill="var(--green1)" opacity=".85"/>

          <path d="M92 276 C190 245, 280 270, 350 285 C430 250, 500 260, 568 280

                   L568 308 L92 308 Z"

                fill="var(--green2)" opacity=".70"/>

          <line x1="330" y1="92" x2="330" y2="308" stroke="rgba(120,110,100,.20)" stroke-width="6"/>

        </g>

        <!-- SHELF + ITEMS -->

        <g>

          <rect x="755" y="132" width="170" height="20" rx="10" fill="#e7c9a4" opacity=".85"/>

          <g transform="translate(755 -36) scale(0.8 1)">

            <path d="M26 92 C26 66, 56 54, 78 60 C98 64, 98 74, 98 92 L98 140

                     C98 158, 86 168, 62 168 C38 168, 26 158, 26 140 Z"

                  fill="var(--cream)" stroke="rgba(120,110,100,.22)" stroke-width="3"/>

            <path d="M98 95 C118 98, 120 122, 104 128" fill="none"

                  stroke="rgba(120,110,100,.30)" stroke-width="6" stroke-linecap="round"/>

            <rect x="50" y="46" width="26" height="18" rx="7"

                  fill="var(--cream)" stroke="rgba(120,110,100,.22)" stroke-width="3"/>

          </g>

          <g transform="translate(847 86.4) scale(0.40)">

            <path d="M0 40 C0 18, 22 8, 38 10 C58 12, 68 20, 68 40 L68 86

                     C68 100, 56 112, 34 112 C12 112, 0 100, 0 86 Z"

                  fill="#e9c8a9" stroke="rgba(120,110,100,.20)" stroke-width="3"/>

            <rect x="14" y="0" width="40" height="18" rx="9" fill="#d7b092" opacity=".9"/>

            <path d="M18 60 C26 52, 42 52, 52 60" stroke="rgba(120,110,100,.16)" stroke-width="3" fill="none"/>

          </g>

          <g transform="translate(876 86.4) scale(0.40)">

            <path d="M0 42 C0 20, 22 10, 38 12 C58 14, 68 22, 68 42 L68 88

                     C68 102, 56 114, 34 114 C12 114, 0 102, 0 88 Z"

                  fill="#e9c8a9" stroke="rgba(120,110,100,.20)" stroke-width="3"/>

            <rect x="14" y="2" width="40" height="18" rx="9" fill="#d7b092" opacity=".9"/>

            <path d="M18 62 C26 54, 42 54, 52 62" stroke="rgba(120,110,100,.16)" stroke-width="3" fill="none"/>

          </g>

        </g>

        <!-- COUNTER -->

        <g>

          <rect x="0" y="380" width="1000" height="170" fill="var(--counter)"/>

          <rect x="0" y="372" width="1000" height="10" fill="var(--counterEdge)" opacity=".9"/>

          <line x1="0" y1="550" x2="1000" y2="550" stroke="rgba(120,110,100,.20)" stroke-width="3"/>

        </g>

        <!-- STOVE + POT -->

        <g filter="url(#softShadow)">

          <rect x="70" y="412" width="260" height="110" rx="14" fill="var(--stove)"/>

          <rect x="92" y="504" width="40" height="8" rx="4" fill="rgba(255,255,255,.22)"/>

          <rect x="140" y="504" width="30" height="8" rx="4" fill="rgba(255,255,255,.16)"/>

          <rect x="178" y="504" width="32" height="8" rx="4" fill="rgba(255,255,255,.13)"/>

          <g transform="translate(130 330)">

            <ellipse cx="70" cy="150" rx="74" ry="14" fill="rgba(235,110,70,.35)"/>

            <path d="M20 92 C20 62, 44 48, 70 48 C96 48, 120 62, 120 92

                     L120 130 C120 150, 100 162, 70 162 C40 162, 20 150, 20 130 Z"

                  fill="var(--potBody)" stroke="rgba(120,110,100,.26)" stroke-width="3"/>

            <path d="M26 76 C34 54, 54 44, 70 44 C86 44, 106 54, 114 76

                     C96 84, 44 84, 26 76 Z"

                  fill="var(--potLid)" stroke="rgba(120,110,100,.22)" stroke-width="3"/>

            <circle cx="70" cy="42" r="9" fill="var(--potLid)" stroke="rgba(120,110,100,.22)" stroke-width="3"/>

            <path d="M16 110 C2 108, 2 130, 16 128" fill="none"

                  stroke="rgba(120,110,100,.30)" stroke-width="7" stroke-linecap="round"/>

            <path d="M124 110 C138 108, 138 130, 124 128" fill="none"

                  stroke="rgba(120,110,100,.30)" stroke-width="7" stroke-linecap="round"/>

          </g>

        </g>

        <!-- BOWLS -->

        <g filter="url(#softShadow)" opacity=".96">

          <ellipse cx="405" cy="520" rx="58" ry="12" fill="rgba(0,0,0,.10)"/>

          <path d="M346 480 C346 454, 372 440, 405 440 C438 440, 464 454, 464 480

                   C464 512, 438 528, 405 528 C372 528, 346 512, 346 480 Z"

                fill="var(--cream)" stroke="rgba(120,110,100,.20)" stroke-width="3"/>

          <path d="M360 490 C382 502, 430 502, 450 490" fill="none"

                stroke="rgba(120,110,100,.14)" stroke-width="3"/>

          <g transform="translate(35 0)">

            <ellipse cx="478" cy="498" rx="42" ry="10" fill="rgba(0,0,0,.08)"/>

            <path d="M436 472 C436 452, 454 440, 478 440 C502 440, 520 452, 520 472

                     C520 496, 502 510, 478 510 C454 510, 436 496, 436 472 Z"

                  fill="var(--cream)" stroke="rgba(120,110,100,.20)" stroke-width="3"/>

            <path d="M448 474 C462 486, 494 486, 510 474" fill="none"

                  stroke="rgba(120,110,100,.14)" stroke-width="3"/>

          </g>

        </g>

        <!-- SINK + FAUCET -->

        <g filter="url(#softShadow)">

          <rect x="640" y="425" width="240" height="95" rx="18"

                fill="var(--sinkFill)" stroke="rgba(120,110,100,.22)" stroke-width="3"/>

          <rect x="662" y="445" width="196" height="55" rx="14"

                fill="var(--sinkInner)" opacity=".40"/>

          <ellipse cx="760" cy="425" rx="18" ry="6" fill="rgba(0,0,0,.08)"/>

          <path d="M760 425

                   L760 352

                   C760 334, 778 328, 794 334

                   C806 339, 808 370, 800 360"

                fill="none" stroke="rgba(120,110,100,.42)" stroke-width="18" stroke-linecap="round"/>

          <path d="M750 400 C742 400, 730 405, 740 410"

                fill="none" stroke="rgba(120,110,100,.40)" stroke-width="10" stroke-linecap="round"/>

          <path d="M840 448 C848 456, 848 488, 840 496"

                stroke="rgba(120,110,100,.18)" stroke-width="4" fill="none" stroke-linecap="round"/>

        </g>

        <!-- VEGGIE BOWL -->

        <g filter="url(#softShadow)">

          <ellipse cx="935" cy="520" rx="55" ry="12" fill="rgba(0,0,0,.10)"/>

          <path d="M885 480 C885 455, 905 440, 935 440 C965 440, 985 455, 985 480

                   C985 510, 965 528, 935 528 C905 528, 885 510, 885 480 Z"

                fill="var(--cream)" stroke="rgba(120,110,100,.20)" stroke-width="3"/>

          <g transform="translate(935 492)">

            <path d="M-28 -18

                     C-18 -38, 10 -40, 20 -26

                     C34 -42, 58 -26, 44 -10

                     C62 -6, 54 18, 30 14

                     C20 34, -6 32, -10 14

                     C-30 26, -54 8, -44 -10

                     C-64 -14, -52 -34, -28 -18 Z"

                  fill="var(--green1)" opacity=".92"/>

            <path d="M-18 -14

                     C-10 -30, 10 -30, 18 -18

                     C28 -28, 44 -18, 34 -6

                     C46 -2, 38 14, 22 12

                     C16 24, -2 24, -6 12

                     C-20 18, -34 6, -28 -6

                     C-44 -10, -34 -26, -18 -14 Z"

                  fill="var(--green2)" opacity=".80"/>

            <path d="M-14 -6

                     C-6 -18, 8 -18, 14 -10

                     C20 -18, 30 -10, 24 0

                     C34 6, 26 18, 14 14

                     C8 22, -4 20, -6 12

                     C-18 16, -26 4, -14 -6 Z"

                  fill="var(--green3)" opacity=".55"/>

            <circle cx="-10" cy="10" r="11.5" fill="rgba(215,70,60,.90)"/>

            <circle cx="10"  cy="10" r="11.5" fill="rgba(215,70,60,.90)"/>

          </g>

        </g>

        <!-- CABINETS -->

        <g>

          <rect x="0" y="550" width="1000" height="300" fill="url(#woodGrad)"/>

          <g stroke="rgba(120,110,100,.20)" stroke-width="4" fill="none">

            <rect x="40"  y="585" width="210" height="235" rx="10"/>

            <rect x="270" y="585" width="210" height="235" rx="10"/>

            <rect x="500" y="585" width="210" height="235" rx="10"/>

            <rect x="730" y="585" width="230" height="235" rx="10"/>

          </g>

          <g stroke="rgba(120,110,100,.33)" stroke-width="10" stroke-linecap="round">

            <line x1="190" y1="695" x2="190" y2="730"/>

            <line x1="320" y1="695" x2="320" y2="730"/>

            <line x1="650" y1="695" x2="650" y2="730"/>

            <line x1="780" y1="695" x2="780" y2="730"/>

          </g>

          <g stroke="rgba(120,110,100,.12)" stroke-width="3" stroke-linecap="round">

            <path d="M120 650 l0 40" />

            <path d="M410 640 l0 50" />

            <path d="M590 650 l0 45" />

            <path d="M900 635 l0 55" />

          </g>

        </g>

        <rect x="0" y="830" width="1000" height="20" fill="#f3d36e" opacity=".35"/>

      </svg>

      <!-- Home Screen -->

      <div id="home-screen" class="screen active">

        <div class="home-screen">
          <div class="camera-ui">
            <div class="camera-title">
              <h1>Breakfast Rating</h1>
              <p>Center your plate/bowl in the circle</p>
            </div>

            <div class="camera-circle" aria-label="Camera Preview">
              <video id="cameraVideo" autoplay playsinline muted></video>
              <img id="capturedImage" alt="Captured" style="display:none;" />
              <div id="cameraHint" class="hint" style="display: none;">
                <!-- Camera hint removed - using native camera instead -->
              </div>
            </div>

            <div class="camera-controls" aria-label="Camera Controls">
              <button class="circle-btn camera" id="btnCapture" title="Capture">üì∏</button>
              <button class="circle-btn library" id="btnLibrary" title="Choose from Library">üì∑</button>
              <button class="circle-btn check" id="btnConfirm" title="Confirm">‚úÖ</button>
              <button class="circle-btn redo" id="btnRedo" title="Retake">‚Üª</button>
            </div>

            <div class="status-line" id="statusLine"></div>

            <div class="rating-notes" aria-label="Rating and notes">
              <div class="rating-label">How was this breakfast?</div>
              <div class="rating-stars" id="ratingStars">
                <span class="rating-star" data-value="1">‚òÖ</span>
                <span class="rating-star" data-value="2">‚òÖ</span>
                <span class="rating-star" data-value="3">‚òÖ</span>
                <span class="rating-star" data-value="4">‚òÖ</span>
                <span class="rating-star" data-value="5">‚òÖ</span>
              </div>
              <textarea
                id="notesInput"
                class="notes-input"
                placeholder="Add a quick note‚Ä¶ e.g. ‚Äúchia pudding with berries, felt light but filling‚Äù"
              ></textarea>
            </div>
          </div>

        </div>

      </div>

      <!-- Weekly Summary Screen -->

      <div id="weekly-screen" class="screen">

        <div class="weekly-screen">

          <div class="header">

            <h2 class="header-title">Weekly Summary</h2>

            <div class="week-range">
              <span class="week-nav" id="prevWeek" title="Previous week">‚Üê</span>
              <span id="weekRangeLabel">Mon - Sun</span>
              <span class="week-nav" id="nextWeek" title="Next week">‚Üí</span>
            </div>

          </div>

          <div class="stats-card">
            <div class="stats-row">
              <div class="stat-item">
                <div class="stat-value" id="statTotalBreakfasts">0</div>
                <div class="stat-label">Breakfasts</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="statAvgRating">‚Äî</div>
                <div class="stat-label">Avg Rating</div>
              </div>
            </div>
          </div>

          <div class="bottles-container">

            <h3 class="bottles-title">This Week's Breakfasts</h3>

            <div class="bottles-row">

              <!-- Monday -->

              <div class="spice-bottle" onclick="alert('Monday: Scrambled Eggs - 4 stars')">

                <div class="bottle-cap"></div>

                <div class="bottle-body">

                  <div class="bottle-fill fill-eggs" style="height: 60%;"></div>

                  <div class="bottle-label">

                    <div class="weekday-label">MON</div>

                    <div class="thumbnail">üç≥</div>

                    <div class="stars">

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star">‚òÖ</span>

                    </div>

                    <div class="food-label">EGGS</div>

                    <div class="note-text"></div>

                  </div>

                </div>

              </div>

              <!-- Tuesday -->

              <div class="spice-bottle" onclick="alert('Tuesday: Oatmeal - 5 stars')">

                <div class="bottle-cap"></div>

                <div class="bottle-body">

                  <div class="bottle-fill fill-oatmeal" style="height: 100%;"></div>

                  <div class="bottle-label">

                    <div class="weekday-label">TUE</div>

                    <div class="thumbnail">ü•£</div>

                    <div class="stars">

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                    </div>

                    <div class="food-label">OATMEAL</div>

                    <div class="note-text"></div>

                  </div>

                </div>

              </div>

              <!-- Wednesday -->

              <div class="spice-bottle" onclick="alert('Wednesday: Chia Pudding - 3 stars')">

                <div class="bottle-cap"></div>

                <div class="bottle-body">

                  <div class="bottle-fill fill-chia" style="height: 40%;"></div>

                  <div class="bottle-label">

                    <div class="weekday-label">WED</div>

                    <div class="thumbnail">üçÆ</div>

                    <div class="stars">

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star">‚òÖ</span>

                      <span class="star">‚òÖ</span>

                    </div>

                    <div class="food-label">CHIA PUD</div>

                    <div class="note-text"></div>

                  </div>

                </div>

              </div>

              <!-- Thursday -->

              <div class="spice-bottle" onclick="alert('Thursday: Fruit Bowl - 2 stars')">

                <div class="bottle-cap"></div>

                <div class="bottle-body">

                  <div class="bottle-fill fill-fruit" style="height: 20%;"></div>

                  <div class="bottle-label">

                    <div class="weekday-label">THU</div>

                    <div class="thumbnail">üçì</div>

                    <div class="stars">

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star">‚òÖ</span>

                      <span class="star">‚òÖ</span>

                      <span class="star">‚òÖ</span>

                    </div>

                    <div class="food-label">FRUIT</div>

                    <div class="note-text"></div>

                  </div>

                </div>

              </div>

              <!-- Friday -->

              <div class="spice-bottle" onclick="alert('Friday: No entry')">

                <div class="bottle-cap"></div>

                <div class="bottle-body">

                  <!-- empty fill + label + thumbnail + 5 grey stars by default -->
                  <div class="bottle-fill fill-default" style="height: 0%;"></div>

                  <div class="bottle-label">

                    <div class="weekday-label">FRI</div>

                    <div class="thumbnail"></div>

                    <div class="stars">
                      <span class="star">‚òÖ</span>
                      <span class="star">‚òÖ</span>
                      <span class="star">‚òÖ</span>
                      <span class="star">‚òÖ</span>
                      <span class="star">‚òÖ</span>
                    </div>

                    <div class="food-label"></div>

                    <div class="note-text"></div>

                    <div class="empty-label">‚Äî</div>

                  </div>

                </div>

              </div>

              <!-- Saturday -->

              <div class="spice-bottle" onclick="alert('Saturday: Yogurt - 4 stars')">

                <div class="bottle-cap"></div>

                <div class="bottle-body">

                  <div class="bottle-fill fill-yogurt" style="height: 60%;"></div>

                  <div class="bottle-label">

                    <div class="weekday-label">SAT</div>

                    <div class="thumbnail">ü•õ</div>

                    <div class="stars">

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star">‚òÖ</span>

                    </div>

                    <div class="food-label">YOGURT</div>

                    <div class="note-text"></div>

                  </div>

                </div>

              </div>

              <!-- Sunday -->

              <div class="spice-bottle" onclick="alert('Sunday: Pancakes - 5 stars')">

                <div class="bottle-cap"></div>

                <div class="bottle-body">

                  <div class="bottle-fill fill-eggs" style="height: 100%;"></div>

                  <div class="bottle-label">

                    <div class="weekday-label">SUN</div>

                    <div class="thumbnail">ü•û</div>

                    <div class="stars">

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                      <span class="star filled">‚òÖ</span>

                    </div>

                    <div class="food-label">PANCAKES</div>

                    <div class="note-text"></div>

                  </div>

                </div>

              </div>

            </div>

          </div>

        </div>

      </div>

    </div>

    <!-- Modal for adding past breakfast entry -->
    <div id="addPastModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalDayTitle">Add Breakfast</h2>
          <button class="modal-close" onclick="closeAddPastModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="modal-image-container">
            <img id="modalPastImage" src="" alt="Breakfast photo" style="display: none; max-width: 100%; max-height: 200px; border-radius: 8px; margin: 10px 0;" />
            <div id="modalImagePlaceholder" style="width: 100%; height: 200px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999; margin: 10px 0;">
              No photo selected
            </div>
          </div>
          <button id="btnPickFromLibrary" class="modal-btn" onclick="event.preventDefault(); event.stopPropagation(); pickFromLibraryForPast(); return false;" style="width: 100%; padding: 12px; margin: 10px 0; background: #FFB800; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            üì∑ Pick from Library
          </button>
          <div class="modal-rating">
            <label style="display: block; margin: 15px 0 8px 0; font-weight: 600; color: #333;">Rating:</label>
            <div class="modal-stars">
              <span class="modal-star" data-value="1" onclick="setModalRating(1)">‚òÖ</span>
              <span class="modal-star" data-value="2" onclick="setModalRating(2)">‚òÖ</span>
              <span class="modal-star" data-value="3" onclick="setModalRating(3)">‚òÖ</span>
              <span class="modal-star" data-value="4" onclick="setModalRating(4)">‚òÖ</span>
              <span class="modal-star" data-value="5" onclick="setModalRating(5)">‚òÖ</span>
            </div>
          </div>
          <div class="modal-notes">
            <label style="display: block; margin: 15px 0 8px 0; font-weight: 600; color: #333;">Notes:</label>
            <textarea id="modalNotesInput" placeholder="Add notes about your breakfast..." style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
          </div>
          <button id="btnSavePast" class="modal-btn" onclick="savePastBreakfast()" style="width: 100%; padding: 12px; margin: 15px 0 0 0; background: #4CAF50; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            ‚úÖ Save
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>

    let stream = null;
    let lastCaptureDataUrl = null;
    let currentRating = 0;
    let weekEntries = new Array(7).fill(null); // Mon=0 ... Sun=6
    let currentWeekStart = null; // Monday of the current week being viewed

    // Load data from localStorage on page load
    function loadFromStorage() {
      try {
        const saved = localStorage.getItem('breakfastEntries');
        if (saved) {
          const allEntries = JSON.parse(saved);
          // Load entries for current week
          updateWeekEntries(allEntries);
        }
      } catch (e) {
        console.error('Error loading from storage:', e);
      }
    }

    // Save data to localStorage
    function saveToStorage() {
      try {
        // Get all existing entries
        const saved = localStorage.getItem('breakfastEntries');
        const allEntries = saved ? JSON.parse(saved) : [];
        
        // Create a map for quick lookup and update
        const entryMap = new Map(allEntries.map(entry => [entry.dateKey, entry]));
        
        // Update or add entries for current week
        const monday = getMondayOfWeek(currentWeekStart || new Date());
        weekEntries.forEach((entry, index) => {
          if (entry) {
            // Use the entry's date if it exists, otherwise calculate from week start
            let entryDate;
            if (entry.date) {
              // If entry has a date, use it (for past entries)
              entryDate = entry.date instanceof Date ? entry.date : new Date(entry.date);
            } else {
              // Otherwise calculate from week start (for current entries)
              entryDate = new Date(monday);
              entryDate.setDate(monday.getDate() + index);
            }
            const dateKey = entryDate.toISOString().split('T')[0];
            
            // Update entry with correct date
            entryMap.set(dateKey, {
              ...entry,
              date: entryDate,
              dateKey: dateKey,
              timestamp: entryDate.getTime()
            });
          }
        });
        // Save all entries at once
        localStorage.setItem('breakfastEntries', JSON.stringify(Array.from(entryMap.values())));
      } catch (e) {
        console.error('Error saving to storage:', e);
      }
    }

    // Update weekEntries array based on allEntries for the current week
    function updateWeekEntries(allEntries) {
      const monday = getMondayOfWeek(currentWeekStart || new Date());
      weekEntries = new Array(7).fill(null);
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(date.getDate() + i);
        const dateKey = date.toISOString().split('T')[0];
        const entry = allEntries.find(e => e.dateKey === dateKey);
        if (entry) {
          weekEntries[i] = entry;
        }
      }
      
      renderWeekBottles();
      renderWeekStats();
    }

    // Get Monday of the week for a given date
    function getMondayOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
      return new Date(d.setDate(diff));
    }

    // Navigate to previous week
    function goToPreviousWeek() {
      const monday = getMondayOfWeek(currentWeekStart || new Date());
      monday.setDate(monday.getDate() - 7);
      currentWeekStart = monday;
      updateWeekRangeLabel();
      loadFromStorage();
    }

    // Navigate to next week
    function goToNextWeek() {
      const monday = getMondayOfWeek(currentWeekStart || new Date());
      monday.setDate(monday.getDate() + 7);
      currentWeekStart = monday;
      updateWeekRangeLabel();
      loadFromStorage();
    }

    // Update week range label
    function updateWeekRangeLabel() {
      const monday = getMondayOfWeek(currentWeekStart || new Date());
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      const fmt = (d) => d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      const rangeEl = document.getElementById('weekRangeLabel');
      if (rangeEl) {
        rangeEl.textContent = `${fmt(monday)} - ${fmt(sunday)}`;
      }
    }

    const elVideo = () => document.getElementById('cameraVideo');
    const elImg = () => document.getElementById('capturedImage');
    const elHint = () => document.getElementById('cameraHint');
    const elStatus = () => document.getElementById('statusLine');

    function setStatus(msg) {
      const el = elStatus();
      if (el) el.textContent = msg || '';
    }

    async function startCamera() {
      try {
        if (stream) return;
        
        // Check if getUserMedia is available
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          // Don't show error message - just silently fail and let user use library button
          const h = elHint();
          if (h) h.style.display = 'none';
          return;
        }
        
        const constraints = {
          video: {
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 },
          },
          audio: false,
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        const v = elVideo();
        if (v) {
          v.srcObject = stream;
          v.setAttribute('playsinline', 'true');
          v.setAttribute('webkit-playsinline', 'true');
        }
        elHint().style.display = 'none';
        setStatus('Live camera ready. Tap üì∏ to capture.');
      } catch (e) {
        console.error('Camera error:', e);
        let errorMsg = 'Camera access blocked or unavailable.';
        if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
          errorMsg = 'Camera permission denied. Please allow camera access in device settings.';
        } else if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') {
          errorMsg = 'No camera found on this device.';
        } else if (e.name === 'NotReadableError' || e.name === 'TrackStartError') {
          errorMsg = 'Camera is being used by another app.';
        } else {
          errorMsg = 'Camera error: ' + (e.message || e.name);
        }
        setStatus(errorMsg);
        const h = elHint();
        if (h) {
          h.style.display = 'none'; // Hide hint - user can use library button instead
        }
      }
    }

    function stopCamera() {
      if (!stream) return;
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }

    function captureFrame() {
      // Check if we're in a WebView (React Native)
      // If so, request native camera instead
      if (window.ReactNativeWebView || window.webkit?.messageHandlers) {
        // Send message to React Native to open native camera
        const message = JSON.stringify({ type: 'requestNativeCamera' });
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(message);
        } else if (window.webkit?.messageHandlers?.reactNative) {
          window.webkit.messageHandlers.reactNative.postMessage(message);
        }
        setStatus('Opening native camera...');
        return;
      }

      // Fallback to web camera if available
      const v = elVideo();
      if (!v || !v.videoWidth) {
        setStatus('Camera not ready yet.');
        return;
      }

      const size = Math.min(v.videoWidth, v.videoHeight);
      const sx = (v.videoWidth - size) / 2;
      const sy = (v.videoHeight - size) / 2;

      const canvas = document.createElement('canvas');
      canvas.width = 720;
      canvas.height = 720;
      const ctx = canvas.getContext('2d');

      // Mirror to match the live preview mirroring
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(v, sx, sy, size, size, 0, 0, canvas.width, canvas.height);

      lastCaptureDataUrl = canvas.toDataURL('image/jpeg', 0.9);
      const img = elImg();
      img.src = lastCaptureDataUrl;
      img.style.display = 'block';
      v.style.display = 'none';
      setStatus('Captured. Tap ‚úÖ to confirm or ‚Üª to retake.');
    }

    // Handle native camera image from React Native
    function handleNativeCameraImage(imageDataUrl) {
      lastCaptureDataUrl = imageDataUrl;
      const img = elImg();
      const v = elVideo();
      if (img) {
        img.src = imageDataUrl;
        img.style.display = 'block';
      }
      if (v) {
        v.style.display = 'none';
      }
      elHint().style.display = 'none';
      setStatus('Captured. Tap ‚úÖ to confirm or ‚Üª to retake.');
    }

    // Handle library image from React Native (for main camera screen)
    function handleLibraryImageForMain(imageDataUrl) {
      console.log('handleLibraryImageForMain called with imageDataUrl length:', imageDataUrl ? imageDataUrl.length : 0);
      lastCaptureDataUrl = imageDataUrl;
      const img = elImg();
      const v = elVideo();
      if (img) {
        img.src = imageDataUrl;
        img.style.display = 'block';
        console.log('Image element updated, display:', img.style.display);
      }
      if (v) {
        v.style.display = 'none';
      }
      elHint().style.display = 'none';
      setStatus('Photo selected. Tap ‚úÖ to confirm or ‚Üª to retake.');
    }
    
    // Make function globally available
    window.handleLibraryImageForMain = handleLibraryImageForMain;

    // Make functions available globally for injected JavaScript
    window.handleNativeCameraImage = handleNativeCameraImage;
    window.handleCameraError = function(error) {
      setStatus(error || 'Camera error occurred.');
      const h = elHint();
      if (h) {
        h.innerHTML = error || 'Camera error occurred.';
        h.style.display = 'grid';
      }
    };

    // Listen for messages from React Native WebView
    // React Native WebView injects a message handler
    if (window.ReactNativeWebView) {
      // Override the default message handler
      const originalPostMessage = window.ReactNativeWebView.postMessage;
      window.ReactNativeWebView.postMessage = function(data) {
        originalPostMessage.call(this, data);
      };
    }

    // Set up message listener for React Native WebView
    window.addEventListener('message', (event) => {
      try {
        // React Native WebView sends messages via postMessage
        const message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
        if (message.type === 'cameraImage' && message.imageDataUrl) {
          handleNativeCameraImage(message.imageDataUrl);
        } else if (message.type === 'cameraError') {
          setStatus(message.error || 'Camera error occurred.');
          const h = elHint();
          if (h) {
            h.innerHTML = message.error || 'Camera error occurred.';
            h.style.display = 'grid';
          }
        }
      } catch (e) {
        // Not a JSON message, ignore
      }
    });

    function redoCapture() {
      lastCaptureDataUrl = null;
      const v = elVideo();
      const img = elImg();
      if (img) img.style.display = 'none';
      if (v) v.style.display = 'block';
      setStatus('Retake: Tap üì∏ when ready.');
    }

    function confirmCapture() {
      if (!lastCaptureDataUrl) {
        setStatus('No photo captured yet. Tap üì∏ first.');
        return;
      }
      if (!currentRating) {
        setStatus('Choose a rating (tap a star) before confirming.');
        return;
      }
      const notes = (document.getElementById('notesInput') || {}).value || '';
      saveBreakfastEntry(currentRating, notes, lastCaptureDataUrl);
      setStatus(`Saved as ${currentRating}‚òÖ${notes ? ' with notes.' : '.'} It will appear in Weekly Summary.`);
      // After saving, return to live camera so you can take the next breakfast
      redoCapture();
      clearRatingAndNotes();
    }

    function saveBreakfastEntry(rating, notes, imageDataUrl, specificDate = null) {
      let targetDate;
      let weekdayIndex;
      
      if (specificDate) {
        // Use the specific date provided (for past entries)
        targetDate = new Date(specificDate);
        // Calculate which day of the week (Monday = 0, Sunday = 6)
        const jsDay = targetDate.getDay(); // 0=Sun .. 6=Sat
        weekdayIndex = jsDay === 0 ? 6 : jsDay - 1;
      } else {
        // Use today's date (for current entries)
        targetDate = new Date();
        const jsDay = targetDate.getDay(); // 0=Sun .. 6=Sat
        weekdayIndex = jsDay === 0 ? 6 : jsDay - 1;
      }

      weekEntries[weekdayIndex] = {
        date: targetDate,
        rating,
        notes,
        imageDataUrl,
      };
      
      saveToStorage(); // Save to localStorage
      renderWeekBottles();
      renderWeekStats();
    }

    function renderWeekBottles() {
      const bottleEls = Array.from(document.querySelectorAll('.spice-bottle'));
      const weekdayLabels = ['MON','TUE','WED','THU','FRI','SAT','SUN'];

      bottleEls.forEach((bottle, index) => {
        const entry = weekEntries[index];
        const labelEl = bottle.querySelector('.weekday-label');
        const fillEl = bottle.querySelector('.bottle-fill');
        const foodLabelEl = bottle.querySelector('.food-label');
        const noteTextEl = bottle.querySelector('.note-text');
        const emptyLabelEl = bottle.querySelector('.empty-label');
        const thumbEl = bottle.querySelector('.thumbnail');
        const stars = bottle.querySelectorAll('.star');

        if (labelEl) labelEl.textContent = weekdayLabels[index];

        if (!entry) {
          // Empty/default state for that day:
          // - 0% fill
          // - 5 grey stars
          // - no thumbnail
          // - no label text
          if (fillEl) fillEl.style.height = '0%';
          stars.forEach(s => s.classList.remove('filled'));
          if (foodLabelEl) foodLabelEl.textContent = '';
          if (noteTextEl) noteTextEl.textContent = '';
          if (emptyLabelEl) emptyLabelEl.textContent = '';
          if (thumbEl) {
            thumbEl.textContent = '';
            thumbEl.innerHTML = '';
          }
          return;
        }

        // Rating -> fill height: 1‚òÖ=20% ... 5‚òÖ=100%
        const fillPct = 20 + (entry.rating - 1) * 20;
        if (fillEl) fillEl.style.height = `${fillPct}%`;

        stars.forEach((star, i) => {
          if (i < entry.rating) star.classList.add('filled');
          else star.classList.remove('filled');
        });

        // Only show note in note-text area (not in food-label)
        // Clear food-label since we're only showing the note below
        if (foodLabelEl) foodLabelEl.textContent = '';
        if (emptyLabelEl) emptyLabelEl.textContent = '';
        
        // Display full note in note-text area (CSS will handle truncation with ellipsis)
        if (noteTextEl) {
          if (entry.notes && entry.notes.trim()) {
            noteTextEl.textContent = entry.notes.trim();
          } else {
            noteTextEl.textContent = '';
          }
        }
        
        // Thumbnail: show captured image if we have one, otherwise leave empty
        if (thumbEl) {
          thumbEl.textContent = '';
          thumbEl.innerHTML = '';
          if (entry.imageDataUrl) {
            const img = document.createElement('img');
            img.src = entry.imageDataUrl;
            img.alt = 'Breakfast thumbnail';
            thumbEl.appendChild(img);
          }
        }
      });
      
      // Re-attach click handlers after rendering (in case DOM was modified)
      if (typeof setupBottleClickHandlers === 'function') {
        setupBottleClickHandlers();
      } else if (window.setupBottleClickHandlers) {
        window.setupBottleClickHandlers();
      }
    }

    function renderWeekStats() {
      const totals = weekEntries.reduce(
        (acc, entry) => {
          if (!entry) return acc;
          acc.count += 1;
          acc.sumRating += entry.rating;
          return acc;
        },
        { count: 0, sumRating: 0 }
      );

      const totalEl = document.getElementById('statTotalBreakfasts');
      const avgEl = document.getElementById('statAvgRating');

      if (totalEl) totalEl.textContent = String(totals.count);

      if (avgEl) {
        if (!totals.count) {
          avgEl.textContent = '‚Äî';
        } else {
          const avg = totals.sumRating / totals.count;
          avgEl.textContent = avg.toFixed(1);
        }
      }
    }

    function updateStarUI() {
      const stars = document.querySelectorAll('.rating-star');
      stars.forEach((star) => {
        const value = Number(star.getAttribute('data-value') || 0);
        if (value <= currentRating) {
          star.classList.add('selected');
        } else {
          star.classList.remove('selected');
        }
      });
    }

    function clearRatingAndNotes() {
      currentRating = 0;
      updateStarUI();
      const notesEl = document.getElementById('notesInput');
      if (notesEl) notesEl.value = '';
    }

    function showScreen(screenName) {

      // Hide all screens

      document.querySelectorAll('.screen').forEach(screen => {

        screen.classList.remove('active');

      });

      

      // Remove active from all buttons

      document.querySelectorAll('.toggle-btn').forEach(btn => {

        btn.classList.remove('active');

      });

      

      // Show selected screen

      document.getElementById(screenName + '-screen').classList.add('active');

      

      // Activate button

      if (event && event.target) event.target.classList.add('active');

      if (screenName === 'home') {
        startCamera();
      }

    }

    // Wire up buttons
    document.addEventListener('DOMContentLoaded', () => {
      // Default screen: home
      startCamera();

      // Star rating interactions
      document.querySelectorAll('.rating-star').forEach(star => {
        star.addEventListener('click', (e) => {
          const value = Number(star.getAttribute('data-value') || 0);
          currentRating = value;
          updateStarUI();
          setStatus(`You chose ${currentRating}‚òÖ. Add a note or tap ‚úÖ to confirm.`);
        });
      });

      const b1 = document.getElementById('btnCapture');
      const b2 = document.getElementById('btnLibrary');
      const b3 = document.getElementById('btnConfirm');
      const b4 = document.getElementById('btnRedo');

      if (b1) b1.addEventListener('click', (e) => { e.preventDefault(); captureFrame(); });
      if (b2) b2.addEventListener('click', (e) => { e.preventDefault(); pickFromLibrary(); });
      if (b3) b3.addEventListener('click', (e) => { e.preventDefault(); confirmCapture(); });
      if (b4) b4.addEventListener('click', (e) => { e.preventDefault(); redoCapture(); });

      // Set up React Native WebView message handler
      // React Native WebView uses postMessage to send messages to the web page
      // We need to listen for these messages
      const handleRNMessage = (event) => {
        try {
          const message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
          if (message.type === 'cameraImage' && message.imageDataUrl) {
            handleNativeCameraImage(message.imageDataUrl);
          } else if (message.type === 'cameraError') {
            setStatus(message.error || 'Camera error occurred.');
            const h = elHint();
            if (h) {
              h.innerHTML = message.error || 'Camera error occurred.';
              h.style.display = 'grid';
            }
          } else if (message.type === 'libraryImage' && message.imageDataUrl) {
            // Check if modal is open - if so, use modal handler, otherwise use main screen handler
            const modal = document.getElementById('addPastModal');
            if (modal && modal.style.display !== 'none') {
              // Modal is open - use modal handler
              if (window.handleLibraryImage) {
                window.handleLibraryImage(message.imageDataUrl);
              }
            } else {
              // Main screen - use main screen handler
              handleLibraryImageForMain(message.imageDataUrl);
            }
          } else if (message.type === 'libraryError') {
            alert(message.error || 'Image library error occurred.');
          }
        } catch (e) {
          console.error('Error parsing message:', e);
        }
      };

      // Listen for messages (React Native WebView sends via postMessage)
      window.addEventListener('message', handleRNMessage);
      
      // Also set up a direct handler if ReactNativeWebView is available
      if (window.ReactNativeWebView) {
        // Store reference for message handling
        window.handleRNMessage = handleRNMessage;
      }

      // Set up bottle click handlers
      function setupBottleClickHandlers() {
        console.log('Setting up bottle click handlers...');
        const bottles = document.querySelectorAll('.spice-bottle');
        console.log('Found', bottles.length, 'bottles');
        
        bottles.forEach((bottle, idx) => {
          // Remove any old hard-coded inline onclick handlers from earlier demos
          bottle.removeAttribute('onclick');
          
          // Store the index as a data attribute so we can access it reliably
          bottle.setAttribute('data-day-index', idx);

          // Remove existing click listeners by cloning (but preserve data attributes)
          const newBottle = bottle.cloneNode(true);
          newBottle.setAttribute('data-day-index', idx);
          bottle.parentNode.replaceChild(newBottle, bottle);
          const bottleEl = newBottle;

          // Hover effects (for desktop)
          bottleEl.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px) scale(1.05)';
          });
          bottleEl.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
          });

          // Dynamic click: show entry details or open modal to add past entry
          bottleEl.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const dayIndex = parseInt(this.getAttribute('data-day-index') || idx);
            const weekdayLabels = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
            const entry = weekEntries[dayIndex];
            console.log('Bottle clicked! Day index:', dayIndex, 'entry:', entry, 'weekEntries:', weekEntries);
            if (!entry) {
              // No entry - open modal to add past breakfast
              console.log('No entry found, opening modal for day index:', dayIndex);
              console.log('openAddPastModal type:', typeof openAddPastModal, 'window.openAddPastModal:', typeof window.openAddPastModal);
              if (typeof openAddPastModal === 'function') {
                console.log('Calling openAddPastModal directly');
                openAddPastModal(dayIndex);
              } else if (window.openAddPastModal && typeof window.openAddPastModal === 'function') {
                console.log('Calling window.openAddPastModal');
                window.openAddPastModal(dayIndex);
              } else {
                console.error('openAddPastModal is not available!');
                alert('Error: Cannot open modal. Please refresh the page.');
              }
              return false;
            }
            // Has entry - show details
            const note = (entry.notes || '').trim();
            const noteLine = note ? `\nNote: ${note}` : '';
            alert(`${weekdayLabels[dayIndex]}: ${entry.rating}‚òÖ${noteLine}`);
            return false;
          });
          
          console.log('Attached click handler to bottle', idx);
        });
        console.log('Finished setting up bottle click handlers');
      }
      
      // Set up bottle handlers initially
      setupBottleClickHandlers();
      
      // Make function globally available so it can be called from renderWeekBottles
      window.setupBottleClickHandlers = setupBottleClickHandlers;

      // Initialize current week
      currentWeekStart = getMondayOfWeek(new Date());
      updateWeekRangeLabel();
      
      // Load saved data
      loadFromStorage();

      // Wire up week navigation buttons
      const prevBtn = document.getElementById('prevWeek');
      const nextBtn = document.getElementById('nextWeek');
      if (prevBtn) prevBtn.addEventListener('click', goToPreviousWeek);
      if (nextBtn) nextBtn.addEventListener('click', goToNextWeek);

      // Initial render for bottles & stats (keeps defaults but runs once)
      renderWeekBottles();
      renderWeekStats();
    });

    // Modal state for adding past breakfast
    let modalSelectedDayIndex = null;
    let modalSelectedImageDataUrl = null;
    let modalSelectedRating = 0;

    function openAddPastModal(dayIndex) {
      console.log('=== openAddPastModal called with dayIndex:', dayIndex, '===');
      modalSelectedDayIndex = dayIndex;
      modalSelectedImageDataUrl = null;
      modalSelectedRating = 0;
      
      const weekdayLabels = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
      const modal = document.getElementById('addPastModal');
      const title = document.getElementById('modalDayTitle');
      const img = document.getElementById('modalPastImage');
      const placeholder = document.getElementById('modalImagePlaceholder');
      const notesInput = document.getElementById('modalNotesInput');
      
      console.log('Modal element:', modal);
      console.log('Modal current display:', modal ? modal.style.display : 'N/A');
      console.log('Modal computed style:', modal ? window.getComputedStyle(modal).display : 'N/A');
      
      if (modal) {
        modal.style.display = 'block';
        modal.style.zIndex = '9999';
        console.log('Modal display set to block, z-index set to 9999');
        console.log('Modal after setting:', modal.style.display, modal.style.zIndex);
        
        // Force a reflow to ensure the change takes effect
        void modal.offsetHeight;
        
        // Double check it's visible
        const computed = window.getComputedStyle(modal);
        console.log('Modal computed display after setting:', computed.display);
        console.log('Modal computed z-index after setting:', computed.zIndex);
      } else {
        console.error('Modal element not found!');
        alert('Error: Modal element not found in DOM');
      }
      if (title) title.textContent = `Add Breakfast - ${weekdayLabels[dayIndex]}`;
      if (img) {
        img.style.display = 'none';
        img.src = '';
      }
      if (placeholder) placeholder.style.display = 'flex';
      if (notesInput) notesInput.value = '';
      
      // Reset stars
      document.querySelectorAll('.modal-star').forEach(star => {
        star.classList.remove('selected');
      });
      
      console.log('=== Finished openAddPastModal ===');
    }

    function closeAddPastModal() {
      const modal = document.getElementById('addPastModal');
      if (modal) modal.style.display = 'none';
      modalSelectedDayIndex = null;
      modalSelectedImageDataUrl = null;
      modalSelectedRating = 0;
    }

    function setModalRating(rating) {
      modalSelectedRating = rating;
      document.querySelectorAll('.modal-star').forEach(star => {
        const value = Number(star.getAttribute('data-value') || 0);
        if (value <= rating) {
          star.classList.add('selected');
        } else {
          star.classList.remove('selected');
        }
      });
    }

    function pickFromLibrary() {
      // Send message to React Native to pick from library (for main camera screen)
      console.log('pickFromLibrary called - requesting image library');
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ 
          type: 'requestImageLibrary' 
        }));
      } else if (window.webkit?.messageHandlers?.reactNative) {
        window.webkit.messageHandlers.reactNative.postMessage(JSON.stringify({ 
          type: 'requestImageLibrary' 
        }));
      } else {
        alert('Image library picker not available. Please use the native app.');
      }
    }

    function pickFromLibraryForPast() {
      // Send message to React Native to pick from library (for past entry modal)
      console.log('pickFromLibraryForPast called - requesting image library');
      pickFromLibrary(); // Use the same function
    }
    
    // Make functions globally available
    window.pickFromLibrary = pickFromLibrary;
    window.pickFromLibraryForPast = pickFromLibraryForPast;
    window.openAddPastModal = openAddPastModal;

    // Handle image from library (called from React Native)
    window.handleLibraryImage = function(imageDataUrl) {
      modalSelectedImageDataUrl = imageDataUrl;
      const img = document.getElementById('modalPastImage');
      const placeholder = document.getElementById('modalImagePlaceholder');
      if (img) {
        img.src = imageDataUrl;
        img.style.display = 'block';
      }
      if (placeholder) placeholder.style.display = 'none';
    };

    function savePastBreakfast() {
      if (!modalSelectedImageDataUrl) {
        alert('Please select a photo from your library.');
        return;
      }
      if (!modalSelectedRating) {
        alert('Please select a rating (tap a star).');
        return;
      }
      
      const notesInput = document.getElementById('modalNotesInput');
      const notes = notesInput ? notesInput.value.trim() : '';
      
      // Calculate the date for the selected day
      const monday = getMondayOfWeek(currentWeekStart || new Date());
      const targetDate = new Date(monday);
      targetDate.setDate(monday.getDate() + modalSelectedDayIndex);
      
      // Save the entry
      saveBreakfastEntry(modalSelectedRating, notes, modalSelectedImageDataUrl, targetDate);
      
      // Close modal
      closeAddPastModal();
      
      alert('Breakfast entry saved!');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('addPastModal');
      if (event.target === modal) {
        closeAddPastModal();
      }
    };

  </script>

</body>

</html>
